"use strict";const{app:h,BrowserWindow:C,ipcMain:l,screen:A,dialog:P,Menu:E,protocol:M}=require("electron"),i=require("path"),a=require("fs"),{setupRemoteServer:R,broadcastStateUpdate:N,closeRemoteServer:L}=require("./remoteServer");let F=null;async function T(){const n=(await Promise.resolve().then(()=>require("./index-DQ2FgvPT.js"))).default;F=new n({name:"settings",defaults:{textScale:100,lastLibraryPath:null,bibleApiKey:null}}),console.log("Settings store initialized")}console.log("Forcing X11/XWayland for Wayland compatibility");h.commandLine.appendSwitch("--ozone-platform=x11");h.commandLine.appendSwitch("--no-sandbox");h.commandLine.appendSwitch("--disable-setuid-sandbox");console.log("Using X11 mode with hardware acceleration enabled");M.registerSchemesAsPrivileged([{scheme:"local-image",privileges:{secure:!0,supportFetchAPI:!0,bypassCSP:!0,stream:!0}}]);let o=null,c=null;global.sendToMainWindow=(n,t)=>{o&&o.webContents&&o.webContents.send(n,t)};function W(){const n=process.platform==="darwin",t=[...n?[{label:h.getName(),submenu:[{role:"about"},{type:"separator"},{role:"hide"},{role:"hideOthers"},{role:"unhide"},{type:"separator"},{role:"quit"}]}]:[],{label:"File",submenu:[n?{role:"close"}:{role:"quit"}]},{label:"Edit",submenu:[{role:"undo"},{role:"redo"},{type:"separator"},{role:"cut"},{role:"copy"},{role:"paste"},{role:"pasteAndMatchStyle"},{role:"delete"},{role:"selectAll"}]},{label:"View",submenu:[{label:"Toggle Fullscreen",accelerator:n?"Ctrl+Cmd+F":"F11",click:()=>{const e=c||o;e&&!e.isDestroyed()&&e.setFullScreen(!e.isFullScreen())}},{type:"separator"},{role:"reload"},{role:"forceReload"},{role:"toggleDevTools"}]},{label:"Window",submenu:[{role:"minimize"},{role:"zoom"},...n?[{type:"separator"},{role:"front"}]:[{role:"close"}]]}],s=E.buildFromTemplate(t);E.setApplicationMenu(s)}const $=!h.isPackaged;console.log("=================================");console.log("app.isPackaged:",h.isPackaged);console.log("Development mode:",$);console.log("process.env.NODE_ENV:",process.env.NODE_ENV);console.log("process.argv:",process.argv);console.log("=================================");$&&h.commandLine.appendSwitch("--disable-features=OutOfBlinkCors");function I(){if(o=new C({width:1400,height:900,frame:!1,fullscreenable:!0,simpleFullscreen:!1,webPreferences:{devTools:!0,preload:i.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!1,allowRunningInsecureContent:!0},title:"DCProjector"}),$){const n=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173";console.log("Loading main window from:",n),o.loadURL(n)}else o.loadFile(i.join(__dirname,"../dist/index.html"));o.webContents.on("did-finish-load",()=>{console.log("Main window finished loading")}),o.webContents.on("did-fail-load",(n,t,s)=>{console.error("Main window failed to load:",t,s)}),o.webContents.on("before-input-event",(n,t)=>{t.control&&t.shift&&t.key.toLowerCase()==="i"&&(o.webContents.toggleDevTools(),n.preventDefault()),t.key==="F12"&&(o.webContents.toggleDevTools(),n.preventDefault())}),o.on("close",()=>{c&&!c.isDestroyed()&&c.close()}),o.on("closed",()=>{o=null,h.quit()})}function z(n=null){if(console.log("====================================="),console.log("Opening projector window (Wayland-compatible mode)"),console.log("Instructions:"),console.log("  1. Drag the window to your projector/display"),console.log("  2. Press F11 to toggle fullscreen"),console.log("  3. Press Escape to exit fullscreen"),console.log("====================================="),c=new C({width:1280,height:720,frame:!0,fullscreen:!1,fullscreenable:!0,simpleFullscreen:!1,skipTaskbar:!1,show:!1,alwaysOnTop:!0,backgroundColor:"#000000",webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:i.join(__dirname,"preload.js"),webSecurity:!1,allowRunningInsecureContent:!0},title:"DCProjector"}),c.once("ready-to-show",()=>{c.show()}),c.webContents.on("before-input-event",(t,s)=>{const e=process.platform==="darwin";if((s.key==="F11"&&!e||s.key==="f"&&s.control&&s.meta&&e)&&s.type==="keyDown"){const m=c.isFullScreen();c.setFullScreen(!m),console.log(m?"ðŸ“º Exited fullscreen":"ðŸ“º Entered fullscreen"),t.preventDefault()}s.key==="Escape"&&s.type==="keyDown"&&c.isFullScreen()&&(c.setFullScreen(!1),console.log("ðŸ“º Exited fullscreen"),t.preventDefault())}),$){const t=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173";c.loadURL(t+"/projector")}else c.loadFile(i.join(__dirname,"../dist/index.html"),{hash:"/projector"});return c.on("closed",()=>{c=null}),c}l.handle("get-available-monitors",()=>{const n=A.getAllDisplays();console.log(`IPC: get-available-monitors returning ${n.length} displays`);const t=n.map((s,e)=>{const r=s.id===A.getPrimaryDisplay().id;return`Monitor ${e+1}${r?" (Primary)":""} - ${s.bounds.width}x${s.bounds.height}`});return console.log("Available monitors:",t),t});l.handle("open-projector-window",(n,t)=>{if(c)return c.focus(),{success:!0};try{return z(t),{success:!0}}catch(s){return console.error("Failed to open projector:",s),{success:!1,error:s.message}}});l.handle("close-projector-window",()=>(c&&(c.close(),c=null),{success:!0}));l.handle("update-projector",(n,t)=>(console.log("Main: Received update-projector, data length:",t.length),c&&!c.isDestroyed()?(console.log("Main: Sending to projector window"),c.webContents.send("update-slide",t),{success:!0}):(console.log("Main: Projector window not available"),{success:!1,error:"Projector window not open"})));l.on("video-ended",()=>{console.log("Main: Video ended notification from projector, forwarding to control window"),o&&!o.isDestroyed()&&o.webContents.send("video-ended-notification")});l.on("control-projector-video",(n,t,s)=>{console.log("Main: Video control command from control window:",t,s),c&&!c.isDestroyed()&&c.webContents.send("video-control-command",t,s)});l.on("video-state-update",(n,t)=>{o&&!o.isDestroyed()&&o.webContents.send("video-state-notification",t)});l.handle("window-minimize",()=>{o&&!o.isDestroyed()&&o.minimize()});l.handle("window-maximize",()=>{o&&!o.isDestroyed()&&(o.isMaximized()?o.unmaximize():o.maximize())});l.handle("window-close",()=>{o&&!o.isDestroyed()&&o.close()});l.handle("settings-get",(n,t)=>F?F.get(t):(console.warn("Settings store not initialized yet"),null));l.handle("settings-set",(n,t,s)=>F?(F.set(t,s),!0):(console.warn("Settings store not initialized yet"),!1));l.handle("settings-delete",(n,t)=>F?(F.delete(t),!0):(console.warn("Settings store not initialized yet"),!1));l.handle("save-presentation",async(n,t)=>{try{const{filePath:s,canceled:e}=await P.showSaveDialog(o,{title:"Save Presentation",defaultPath:"presentation.json",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}]});return!e&&s?(a.writeFileSync(s,t,"utf-8"),{success:!0,filePath:s}):{success:!1,canceled:!0}}catch(s){return console.error("Save failed:",s),{success:!1,error:s.message}}});l.handle("load-presentation",async()=>{try{const{filePaths:n,canceled:t}=await P.showOpenDialog(o,{title:"Load Presentation",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}],properties:["openFile"]});return!t&&n.length>0?{success:!0,data:a.readFileSync(n[0],"utf-8")}:{success:!1,canceled:!0}}catch(n){return console.error("Load failed:",n),{success:!1,error:n.message}}});l.handle("select-images",async()=>{try{const{filePaths:n,canceled:t}=await P.showOpenDialog(o,{title:"Select Images",filters:[{name:"Images",extensions:["png","jpg","jpeg","gif","webp","svg","bmp"]}],properties:["openFile","multiSelections"]});return!t&&n.length>0?{success:!0,files:n}:{success:!1,canceled:!0}}catch(n){return console.error("Image selection failed:",n),{success:!1,error:n.message}}});l.handle("create-library",async(n,t,s)=>{try{const e=i.join(t,`${s}.dclib`);a.mkdirSync(e,{recursive:!0}),a.mkdirSync(i.join(e,"assets","branding"),{recursive:!0}),a.mkdirSync(i.join(e,"assets","media"),{recursive:!0}),a.mkdirSync(i.join(e,"assets",".trash"),{recursive:!0}),a.mkdirSync(i.join(e,"assets",".thumbnails"),{recursive:!0}),a.mkdirSync(i.join(e,"events"),{recursive:!0});const r={name:s,created:new Date().toISOString(),version:"1.0",lastOpened:new Date().toISOString()};return a.writeFileSync(i.join(e,"library.json"),JSON.stringify(r,null,2),"utf-8"),e}catch(e){return console.error("Create library failed:",e),null}});l.handle("load-library-metadata",async(n,t)=>{try{const s=i.join(t,"library.json");if(a.existsSync(s)){const e=a.readFileSync(s,"utf-8");return JSON.parse(e)}return null}catch(s){return console.error("Load library metadata failed:",s),null}});l.handle("save-library-metadata",async(n,t,s)=>{try{const e=i.join(t,"library.json");return a.writeFileSync(e,JSON.stringify(s,null,2),"utf-8"),!0}catch(e){return console.error("Save library metadata failed:",e),!1}});l.handle("list-library-events",async(n,t)=>{try{const s=i.join(t,"events");return a.existsSync(s)?a.readdirSync(s).filter(r=>r.endsWith(".json")).map(r=>r.replace(".json","")).sort():[]}catch(s){return console.error("List library events failed:",s),[]}});l.handle("create-library-event",async(n,t,s)=>{try{const e=i.join(t,"events",`${s}.json`),r={title:s,stacks:[]};return a.writeFileSync(e,JSON.stringify(r,null,2),"utf-8"),e}catch(e){return console.error("Create library event failed:",e),null}});l.handle("load-library-event",async(n,t,s)=>{try{const e=i.join(t,"events",`${s}.json`);if(!a.existsSync(e))return{success:!1,error:"Event not found"};const r=a.readFileSync(e,"utf-8");return{success:!0,data:JSON.parse(r),path:e}}catch(e){return console.error("Load library event failed:",e),{success:!1,error:e.message}}});l.handle("save-library-event",async(n,t,s)=>{try{return a.writeFileSync(t,JSON.stringify(s,null,2),"utf-8"),!0}catch(e){return console.error("Save library event failed:",e),!1}});l.handle("delete-library-event",async(n,t,s)=>{try{const e=i.join(t,"events",`${s}.json`);return a.existsSync(e)?(a.unlinkSync(e),!0):!1}catch(e){return console.error("Delete library event failed:",e),!1}});l.handle("resolve-asset-path",async(n,t,s)=>{try{if(s.startsWith("local-image://"))return s;if(s.startsWith("file://")){let u=s.replace("file://","");return process.platform==="win32"&&u.startsWith("/")&&(u=u.substring(1)),`local-image://${u}`}if(!s.startsWith("assets://"))return s;const e=s.replace("assets://","assets/"),r=i.join(t,e);if(a.existsSync(r))return`local-image://${process.platform==="win32"?r.replace(/\\/g,"/"):r}`;const m=r.replace("/assets/","/assets/.trash/");return a.existsSync(m)?m:null}catch(e){return console.error("Resolve asset path failed:",e),null}});l.handle("select-library-folder",async()=>{try{const{filePaths:n,canceled:t}=await P.showOpenDialog(o,{title:"Select Library Folder",properties:["openDirectory"]});return!t&&n.length>0?{success:!0,path:n[0]}:{success:!1,canceled:!0}}catch(n){return console.error("Select library folder failed:",n),{success:!1,error:n.message}}});l.handle("list-library-assets",async(n,t)=>{try{let e=function(d,b){if(!a.existsSync(d))return;const S=a.readdirSync(d,{withFileTypes:!0});for(const g of S)if(g.isDirectory()){if(g.name===".trash")continue;const y=i.join(d,g.name),v=`${b}${g.name}/`;e(y,v)}else if(g.isFile()){const y=g.name.split(".").pop().toLowerCase(),v=i.join(d,g.name),x=`${b}${g.name}`;let w=null;if(m.includes(y)?w="image":u.includes(y)&&(w="video"),w){const D={filename:g.name,path:v,url:x,type:w};if(w==="video"){const k=`${g.name}.jpg`,O=i.join(t,"assets",".thumbnails",k);a.existsSync(O)&&(D.thumbnailUrl=`assets://.thumbnails/${k}`)}r.push(D)}}};var s=e;if(!t)return{success:!1,assets:[]};const r=[],m=["png","jpg","jpeg","gif","webp","svg","bmp"],u=["mp4","webm","ogg","mov","avi","mkv"],p=i.join(t,"assets","branding");e(p,"assets://branding/");const f=i.join(t,"assets","media");return e(f,"assets://media/"),{success:!0,assets:r}}catch(e){return console.error("List library assets failed:",e),{success:!1,assets:[],error:e.message}}});l.handle("import-assets-to-library",async(n,t,s)=>{try{if(!t)return{success:!1,error:"No library open"};let e=[];s==="image"?e=[{name:"Images",extensions:["png","jpg","jpeg","gif","webp","svg","bmp"]}]:s==="video"?e=[{name:"Videos",extensions:["mp4","webm","ogg","mov","avi","mkv"]}]:e=[{name:"Media Files",extensions:["png","jpg","jpeg","gif","webp","svg","bmp","mp4","webm","ogg","mov","avi","mkv"]}];const{filePaths:r,canceled:m}=await P.showOpenDialog(o,{title:"Import Assets",filters:e,properties:["openFile","multiSelections"]});if(m||r.length===0)return{success:!1,canceled:!0};const u=new Date,p=`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}`,f=i.join(t,"assets","media",p);a.mkdirSync(f,{recursive:!0});const d=[],b=["png","jpg","jpeg","gif","webp","svg","bmp"],S=["mp4","webm","ogg","mov","avi","mkv"];for(const g of r){const y=i.basename(g),v=i.join(f,y);a.copyFileSync(g,v);const x=y.split(".").pop().toLowerCase();let w="unknown";b.includes(x)?w="image":S.includes(x)&&(w="video");const D=`assets://media/${p}/${y}`;d.push({filename:y,path:v,url:D,type:w})}return{success:!0,assets:d}}catch(e){return console.error("Import assets failed:",e),{success:!1,error:e.message}}});l.handle("check-asset-usage",async(n,t,s)=>{try{if(!t||!s)return[];const e=i.join(t,"events");if(!a.existsSync(e))return[];const r=a.readdirSync(e).filter(u=>u.endsWith(".json")),m=[];for(const u of r){const p=i.join(e,u);try{if(a.readFileSync(p,"utf-8").includes(s)){const d=u.replace(".json","");m.push(d)}}catch(f){console.error(`Error reading event file ${u}:`,f)}}return m}catch(e){return console.error("Check asset usage failed:",e),[]}});l.handle("delete-library-asset",async(n,t,s)=>{try{return!t||!s?{success:!1,error:"Invalid parameters"}:s.startsWith(t)?a.existsSync(s)?(a.unlinkSync(s),console.log("Asset deleted:",s),{success:!0}):{success:!1,error:"Asset file not found"}:{success:!1,error:"Asset path is not within library"}}catch(e){return console.error("Delete asset failed:",e),{success:!1,error:e.message}}});l.handle("browse-for-assets",async(n,t)=>{try{let s=[];t==="image"?s=[{name:"Images",extensions:["png","jpg","jpeg","gif","webp","svg","bmp"]}]:t==="video"?s=[{name:"Videos",extensions:["mp4","webm","ogg","mov","avi","mkv"]}]:s=[{name:"Media Files",extensions:["png","jpg","jpeg","gif","webp","svg","bmp","mp4","webm","ogg","mov","avi","mkv"]}];const{filePaths:e,canceled:r}=await P.showOpenDialog(o,{title:"Select Assets",filters:s,properties:["openFile","multiSelections"]});if(r||e.length===0)return{success:!1,canceled:!0};const m=["png","jpg","jpeg","gif","webp","svg","bmp"],u=["mp4","webm","ogg","mov","avi","mkv"];return{success:!0,files:e.map(f=>{const d=i.basename(f),b=d.split(".").pop().toLowerCase();let S="unknown";return m.includes(b)?S="image":u.includes(b)&&(S="video"),{filename:d,path:f,type:S}})}}catch(s){return console.error("Browse for assets failed:",s),{success:!1,error:s.message}}});l.handle("import-assets-with-thumbnails",async(n,t,s)=>{try{if(!t)return{success:!1,error:"No library open"};const e=new Date,r=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,m=i.join(t,"assets","media",r);a.mkdirSync(m,{recursive:!0});const u=i.join(t,"assets",".thumbnails");a.mkdirSync(u,{recursive:!0});const p=[];for(const f of s){const d=f.filename,b=f.path,S=i.join(m,d);a.copyFileSync(b,S);const g=`assets://media/${r}/${d}`,y={filename:d,path:S,url:g,type:f.type};if(f.type==="video"&&f.thumbnailDataUrl)try{const v=`${d}.jpg`,x=i.join(u,v),w=f.thumbnailDataUrl.replace(/^data:image\/\w+;base64,/,""),D=Buffer.from(w,"base64");a.writeFileSync(x,D),y.thumbnailUrl=`assets://.thumbnails/${v}`,console.log(`Saved thumbnail for ${d}`)}catch(v){console.error(`Failed to save thumbnail for ${d}:`,v)}p.push(y)}return console.log("Assets imported with thumbnails:",p),{success:!0,assets:p}}catch(e){return console.error("Import assets with thumbnails failed:",e),{success:!1,error:e.message}}});l.handle("save-video-thumbnail",async(n,t,s,e)=>{try{if(!t||!s||!e)return{success:!1,error:"Invalid parameters"};const r=i.join(t,"assets",".thumbnails");a.mkdirSync(r,{recursive:!0});const u=`${s.split("/").pop()}.jpg`,p=i.join(r,u),f=e.replace(/^data:image\/\w+;base64,/,""),d=Buffer.from(f,"base64");return a.writeFileSync(p,d),console.log("Thumbnail saved:",p),{success:!0,thumbnailUrl:`assets://.thumbnails/${u}`}}catch(r){return console.error("Save video thumbnail failed:",r),{success:!1,error:r.message}}});l.handle("broadcast-presentation-state",async(n,t)=>(N(t),{success:!0}));function j(n){o&&o.webContents&&o.webContents.send("main-process-log",n)}h.setName("DCProjector");h.whenReady().then(async()=>{await T(),W(),M.registerFileProtocol("local-image",(n,t)=>{const s=`local-image protocol request: ${n.url}`;console.log(s),j(s);let e=decodeURIComponent(n.url.replace("local-image://",""));j(`After removing protocol: ${e}`),process.platform==="win32"&&e.match(/^\/[A-Za-z]:/)&&(e=e.substring(1),j(`After removing leading slash: ${e}`)),process.platform==="win32"&&(e=e.replace(/\//g,"\\"),j(`After converting slashes: ${e}`),e.match(/^[A-Za-z]:\\/)||(j(`WARNING: Path missing colon after drive letter: ${e}`),e=e.replace(/^([A-Za-z])\\/,"$1:\\"),j(`Fixed path: ${e}`)));try{if(j(`Checking if file exists: ${e}`),a.existsSync(e)){j(`File exists! Returning path: ${e}`);const r=a.statSync(e),m=i.extname(e).toLowerCase(),p={".mp4":"video/mp4",".webm":"video/webm",".ogg":"video/ogg",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".webp":"image/webp"}[m];p?t({path:e,headers:{"Content-Type":p,"Accept-Ranges":"bytes","Cache-Control":"public, max-age=31536000, immutable",ETag:`"${r.mtime.getTime()}-${r.size}"`,"Last-Modified":r.mtime.toUTCString()}}):(console.log("Returning path to callback:",e),t({path:e}))}else{console.error("Asset file not found:",e);const r=decodeURIComponent(n.url.replace("local-image://",""));console.log("Trying original path:",r),a.existsSync(r)?(console.log("Original path exists!"),t({path:r})):t({error:-6})}}catch(r){console.error("Error loading asset:",e,r),t({error:-2})}}),I(),R(3777),h.on("activate",()=>{C.getAllWindows().length===0&&I()})});h.on("window-all-closed",()=>{L(),process.platform!=="darwin"&&h.quit()});h.on("before-quit",()=>{L()});
