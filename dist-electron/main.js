"use strict";const{app:f,BrowserWindow:F,ipcMain:c,screen:P,dialog:b,Menu:C,protocol:E}=require("electron"),l=require("path"),o=require("fs");console.log("Forcing X11/XWayland for Wayland compatibility");f.commandLine.appendSwitch("--ozone-platform=x11");f.commandLine.appendSwitch("--no-sandbox");f.commandLine.appendSwitch("--disable-setuid-sandbox");console.log("Using X11 mode with hardware acceleration enabled");E.registerSchemesAsPrivileged([{scheme:"local-image",privileges:{secure:!0,supportFetchAPI:!0,bypassCSP:!0,stream:!0}}]);let n=null,i=null;const D=!f.isPackaged;console.log("=================================");console.log("app.isPackaged:",f.isPackaged);console.log("Development mode:",D);console.log("process.env.NODE_ENV:",process.env.NODE_ENV);console.log("process.argv:",process.argv);console.log("=================================");D&&f.commandLine.appendSwitch("--disable-features=OutOfBlinkCors");function k(){n=new F({width:1400,height:900,frame:!1,webPreferences:{devTools:!0,preload:l.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0},title:"DongleControl Projector"});const r=[{label:"View",submenu:[{role:"reload"},{role:"forceReload"},{type:"separator"},{role:"toggleDevTools"},{type:"separator"},{role:"resetZoom"},{role:"zoomIn"},{role:"zoomOut"}]}],t=C.buildFromTemplate(r);if(C.setApplicationMenu(t),D){const s=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173";console.log("Loading main window from:",s),n.loadURL(s)}else n.loadFile(l.join(__dirname,"../dist/index.html"));n.webContents.on("did-finish-load",()=>{console.log("Main window finished loading")}),n.webContents.on("did-fail-load",(s,e,a)=>{console.error("Main window failed to load:",e,a)}),n.webContents.on("before-input-event",(s,e)=>{e.control&&e.shift&&e.key.toLowerCase()==="i"&&(n.webContents.toggleDevTools(),s.preventDefault()),e.key==="F12"&&(n.webContents.toggleDevTools(),s.preventDefault())}),n.on("close",()=>{i&&!i.isDestroyed()&&i.close()}),n.on("closed",()=>{n=null,f.quit()})}function O(r=null){if(console.log("====================================="),console.log("Opening projector window (Wayland-compatible mode)"),console.log("Instructions:"),console.log("  1. Drag the window to your projector/display"),console.log("  2. Press F11 to toggle fullscreen"),console.log("  3. Press Escape to exit fullscreen"),console.log("====================================="),i=new F({width:1280,height:720,frame:!0,fullscreen:!1,skipTaskbar:!1,show:!1,alwaysOnTop:!0,backgroundColor:"#000000",webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:l.join(__dirname,"preload.js")},title:"DongleControl Projector - Drag me to display, then press F11"}),i.once("ready-to-show",()=>{i.show(),console.log("âœ“ Projector window opened"),console.log("ðŸ“Œ Drag it to your target display, then press F11 for fullscreen")}),i.webContents.on("before-input-event",(t,s)=>{if(s.key==="F11"&&s.type==="keyDown"){const e=i.isFullScreen();i.setFullScreen(!e),console.log(e?"ðŸ“º Exited fullscreen":"ðŸ“º Entered fullscreen"),t.preventDefault()}s.key==="Escape"&&s.type==="keyDown"&&i.isFullScreen()&&(i.setFullScreen(!1),console.log("ðŸ“º Exited fullscreen"),t.preventDefault())}),D){const t=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173";i.loadURL(t+"/projector")}else i.loadFile(l.join(__dirname,"../dist/index.html"),{hash:"/projector"});return i.on("closed",()=>{i=null}),i}c.handle("get-available-monitors",()=>{const r=P.getAllDisplays();console.log(`IPC: get-available-monitors returning ${r.length} displays`);const t=r.map((s,e)=>{const a=s.id===P.getPrimaryDisplay().id;return`Monitor ${e+1}${a?" (Primary)":""} - ${s.bounds.width}x${s.bounds.height}`});return console.log("Available monitors:",t),t});c.handle("open-projector-window",(r,t)=>{if(i)return i.focus(),{success:!0};try{return O(t),{success:!0}}catch(s){return console.error("Failed to open projector:",s),{success:!1,error:s.message}}});c.handle("close-projector-window",()=>(i&&(i.close(),i=null),{success:!0}));c.handle("update-projector",(r,t)=>(console.log("Main: Received update-projector, data length:",t.length),i&&!i.isDestroyed()?(console.log("Main: Sending to projector window"),i.webContents.send("update-slide",t),{success:!0}):(console.log("Main: Projector window not available"),{success:!1,error:"Projector window not open"})));c.on("video-ended",()=>{console.log("Main: Video ended notification from projector, forwarding to control window"),n&&!n.isDestroyed()&&n.webContents.send("video-ended-notification")});c.on("control-projector-video",(r,t,s)=>{console.log("Main: Video control command from control window:",t,s),i&&!i.isDestroyed()&&i.webContents.send("video-control-command",t,s)});c.on("video-state-update",(r,t)=>{n&&!n.isDestroyed()&&n.webContents.send("video-state-notification",t)});c.handle("window-minimize",()=>{n&&!n.isDestroyed()&&n.minimize()});c.handle("window-maximize",()=>{n&&!n.isDestroyed()&&(n.isMaximized()?n.unmaximize():n.maximize())});c.handle("window-close",()=>{n&&!n.isDestroyed()&&n.close()});c.handle("save-presentation",async(r,t)=>{try{const{filePath:s,canceled:e}=await b.showSaveDialog(n,{title:"Save Presentation",defaultPath:"presentation.json",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}]});return!e&&s?(o.writeFileSync(s,t,"utf-8"),{success:!0,filePath:s}):{success:!1,canceled:!0}}catch(s){return console.error("Save failed:",s),{success:!1,error:s.message}}});c.handle("load-presentation",async()=>{try{const{filePaths:r,canceled:t}=await b.showOpenDialog(n,{title:"Load Presentation",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}],properties:["openFile"]});return!t&&r.length>0?{success:!0,data:o.readFileSync(r[0],"utf-8")}:{success:!1,canceled:!0}}catch(r){return console.error("Load failed:",r),{success:!1,error:r.message}}});c.handle("select-images",async()=>{try{const{filePaths:r,canceled:t}=await b.showOpenDialog(n,{title:"Select Images",filters:[{name:"Images",extensions:["png","jpg","jpeg","gif","webp","svg","bmp"]}],properties:["openFile","multiSelections"]});return!t&&r.length>0?{success:!0,files:r}:{success:!1,canceled:!0}}catch(r){return console.error("Image selection failed:",r),{success:!1,error:r.message}}});c.handle("create-library",async(r,t,s)=>{try{const e=l.join(t,`${s}.dclib`);o.mkdirSync(e,{recursive:!0}),o.mkdirSync(l.join(e,"assets","branding"),{recursive:!0}),o.mkdirSync(l.join(e,"assets","media"),{recursive:!0}),o.mkdirSync(l.join(e,"assets",".trash"),{recursive:!0}),o.mkdirSync(l.join(e,"events"),{recursive:!0});const a={name:s,created:new Date().toISOString(),version:"1.0",lastOpened:new Date().toISOString()};return o.writeFileSync(l.join(e,"library.json"),JSON.stringify(a,null,2),"utf-8"),e}catch(e){return console.error("Create library failed:",e),null}});c.handle("load-library-metadata",async(r,t)=>{try{const s=l.join(t,"library.json");if(o.existsSync(s)){const e=o.readFileSync(s,"utf-8");return JSON.parse(e)}return null}catch(s){return console.error("Load library metadata failed:",s),null}});c.handle("save-library-metadata",async(r,t,s)=>{try{const e=l.join(t,"library.json");return o.writeFileSync(e,JSON.stringify(s,null,2),"utf-8"),!0}catch(e){return console.error("Save library metadata failed:",e),!1}});c.handle("list-library-events",async(r,t)=>{try{const s=l.join(t,"events");return o.existsSync(s)?o.readdirSync(s).filter(a=>a.endsWith(".json")).map(a=>a.replace(".json","")).sort():[]}catch(s){return console.error("List library events failed:",s),[]}});c.handle("create-library-event",async(r,t,s)=>{try{const e=l.join(t,"events",`${s}.json`),a={title:s,stacks:[]};return o.writeFileSync(e,JSON.stringify(a,null,2),"utf-8"),e}catch(e){return console.error("Create library event failed:",e),null}});c.handle("load-library-event",async(r,t,s)=>{try{const e=l.join(t,"events",`${s}.json`);if(!o.existsSync(e))return{success:!1,error:"Event not found"};const a=o.readFileSync(e,"utf-8");return{success:!0,data:JSON.parse(a),path:e}}catch(e){return console.error("Load library event failed:",e),{success:!1,error:e.message}}});c.handle("save-library-event",async(r,t,s)=>{try{return o.writeFileSync(t,JSON.stringify(s,null,2),"utf-8"),!0}catch(e){return console.error("Save library event failed:",e),!1}});c.handle("delete-library-event",async(r,t,s)=>{try{const e=l.join(t,"events",`${s}.json`);return o.existsSync(e)?(o.unlinkSync(e),!0):!1}catch(e){return console.error("Delete library event failed:",e),!1}});c.handle("resolve-asset-path",async(r,t,s)=>{try{if(!s.startsWith("assets://"))return s;const e=s.replace("assets://","assets/"),a=l.join(t,e);if(o.existsSync(a))return`local-image://${a}`;const p=a.replace("/assets/","/assets/.trash/");return o.existsSync(p)?p:null}catch(e){return console.error("Resolve asset path failed:",e),null}});c.handle("select-library-folder",async()=>{try{const{filePaths:r,canceled:t}=await b.showOpenDialog(n,{title:"Select Library Folder",properties:["openDirectory"]});return!t&&r.length>0?{success:!0,path:r[0]}:{success:!1,canceled:!0}}catch(r){return console.error("Select library folder failed:",r),{success:!1,error:r.message}}});c.handle("list-library-assets",async(r,t)=>{try{let e=function(g,j){if(!o.existsSync(g))return;const x=o.readdirSync(g,{withFileTypes:!0});for(const u of x)if(u.isDirectory()){if(u.name===".trash")continue;const m=l.join(g,u.name),w=`${j}${u.name}/`;e(m,w)}else if(u.isFile()){const m=u.name.split(".").pop().toLowerCase(),w=l.join(g,u.name),S=`${j}${u.name}`;let y=null;p.includes(m)?y="image":d.includes(m)&&(y="video"),y&&a.push({filename:u.name,path:w,url:S,type:y})}};var s=e;if(!t)return{success:!1,assets:[]};const a=[],p=["png","jpg","jpeg","gif","webp","svg","bmp"],d=["mp4","webm","ogg","mov","avi","mkv"],v=l.join(t,"assets","branding");e(v,"assets://branding/");const h=l.join(t,"assets","media");return e(h,"assets://media/"),{success:!0,assets:a}}catch(e){return console.error("List library assets failed:",e),{success:!1,assets:[],error:e.message}}});c.handle("import-assets-to-library",async(r,t,s)=>{try{if(!t)return{success:!1,error:"No library open"};let e=[];s==="image"?e=[{name:"Images",extensions:["png","jpg","jpeg","gif","webp","svg","bmp"]}]:s==="video"?e=[{name:"Videos",extensions:["mp4","webm","ogg","mov","avi","mkv"]}]:e=[{name:"Media Files",extensions:["png","jpg","jpeg","gif","webp","svg","bmp","mp4","webm","ogg","mov","avi","mkv"]}];const{filePaths:a,canceled:p}=await b.showOpenDialog(n,{title:"Import Assets",filters:e,properties:["openFile","multiSelections"]});if(p||a.length===0)return{success:!1,canceled:!0};const d=new Date,v=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`,h=l.join(t,"assets","media",v);o.mkdirSync(h,{recursive:!0});const g=[],j=["png","jpg","jpeg","gif","webp","svg","bmp"],x=["mp4","webm","ogg","mov","avi","mkv"];for(const u of a){const m=l.basename(u),w=l.join(h,m);o.copyFileSync(u,w);const S=m.split(".").pop().toLowerCase();let y="unknown";j.includes(S)?y="image":x.includes(S)&&(y="video");const L=`assets://media/${v}/${m}`;g.push({filename:m,path:w,url:L,type:y})}return{success:!0,assets:g}}catch(e){return console.error("Import assets failed:",e),{success:!1,error:e.message}}});c.handle("check-asset-usage",async(r,t,s)=>{try{if(!t||!s)return[];const e=l.join(t,"events");if(!o.existsSync(e))return[];const a=o.readdirSync(e).filter(d=>d.endsWith(".json")),p=[];for(const d of a){const v=l.join(e,d);try{if(o.readFileSync(v,"utf-8").includes(s)){const g=d.replace(".json","");p.push(g)}}catch(h){console.error(`Error reading event file ${d}:`,h)}}return p}catch(e){return console.error("Check asset usage failed:",e),[]}});c.handle("delete-library-asset",async(r,t,s)=>{try{return!t||!s?{success:!1,error:"Invalid parameters"}:s.startsWith(t)?o.existsSync(s)?(o.unlinkSync(s),console.log("Asset deleted:",s),{success:!0}):{success:!1,error:"Asset file not found"}:{success:!1,error:"Asset path is not within library"}}catch(e){return console.error("Delete asset failed:",e),{success:!1,error:e.message}}});f.whenReady().then(()=>{E.registerFileProtocol("local-image",(r,t)=>{const s=decodeURIComponent(r.url.replace("local-image://",""));try{if(o.existsSync(s)){const e=o.statSync(s),a=l.extname(s).toLowerCase(),d={".mp4":"video/mp4",".webm":"video/webm",".ogg":"video/ogg",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".webp":"image/webp"}[a];t(d?{path:s,headers:{"Content-Type":d,"Accept-Ranges":"bytes","Cache-Control":"public, max-age=31536000, immutable",ETag:`"${e.mtime.getTime()}-${e.size}"`,"Last-Modified":e.mtime.toUTCString()}}:{path:s})}else console.error("Asset file not found:",s),t({error:-6})}catch(e){console.error("Error loading asset:",s,e),t({error:-2})}}),k(),f.on("activate",()=>{F.getAllWindows().length===0&&k()})});f.on("window-all-closed",()=>{process.platform!=="darwin"&&f.quit()});
