"use strict";const{app:g,BrowserWindow:P,ipcMain:c,screen:C,dialog:S,Menu:$,protocol:E}=require("electron"),l=require("path"),i=require("fs");console.log("Forcing X11/XWayland for Wayland compatibility");g.commandLine.appendSwitch("--ozone-platform=x11");g.commandLine.appendSwitch("--no-sandbox");g.commandLine.appendSwitch("--disable-setuid-sandbox");console.log("Using X11 mode with hardware acceleration enabled");E.registerSchemesAsPrivileged([{scheme:"local-image",privileges:{secure:!0,supportFetchAPI:!0,bypassCSP:!0,stream:!0}}]);let o=null,a=null;const D=!g.isPackaged;console.log("=================================");console.log("app.isPackaged:",g.isPackaged);console.log("Development mode:",D);console.log("process.env.NODE_ENV:",process.env.NODE_ENV);console.log("process.argv:",process.argv);console.log("=================================");D&&g.commandLine.appendSwitch("--disable-features=OutOfBlinkCors");function k(){o=new P({width:1400,height:900,frame:!1,webPreferences:{devTools:!0,preload:l.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!1,allowRunningInsecureContent:!0},title:"DongleControl Projector"});const r=[{label:"View",submenu:[{role:"reload"},{role:"forceReload"},{type:"separator"},{role:"toggleDevTools"},{type:"separator"},{role:"resetZoom"},{role:"zoomIn"},{role:"zoomOut"}]}],n=$.buildFromTemplate(r);if($.setApplicationMenu(n),D){const t=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173";console.log("Loading main window from:",t),o.loadURL(t)}else o.loadFile(l.join(__dirname,"../dist/index.html"));o.webContents.on("did-finish-load",()=>{console.log("Main window finished loading")}),o.webContents.on("did-fail-load",(t,e,s)=>{console.error("Main window failed to load:",e,s)}),o.webContents.on("before-input-event",(t,e)=>{e.control&&e.shift&&e.key.toLowerCase()==="i"&&(o.webContents.toggleDevTools(),t.preventDefault()),e.key==="F12"&&(o.webContents.toggleDevTools(),t.preventDefault())}),o.on("close",()=>{a&&!a.isDestroyed()&&a.close()}),o.on("closed",()=>{o=null,g.quit()})}function L(r=null){if(console.log("====================================="),console.log("Opening projector window (Wayland-compatible mode)"),console.log("Instructions:"),console.log("  1. Drag the window to your projector/display"),console.log("  2. Press F11 to toggle fullscreen"),console.log("  3. Press Escape to exit fullscreen"),console.log("====================================="),a=new P({width:1280,height:720,frame:!0,fullscreen:!1,skipTaskbar:!1,show:!1,alwaysOnTop:!0,backgroundColor:"#000000",webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:l.join(__dirname,"preload.js"),webSecurity:!1,allowRunningInsecureContent:!0},title:"DongleControl Projector - Drag me to display, then press F11"}),a.once("ready-to-show",()=>{a.show(),console.log("âœ“ Projector window opened"),console.log("ðŸ“Œ Drag it to your target display, then press F11 for fullscreen")}),a.webContents.on("before-input-event",(n,t)=>{if(t.key==="F11"&&t.type==="keyDown"){const e=a.isFullScreen();a.setFullScreen(!e),console.log(e?"ðŸ“º Exited fullscreen":"ðŸ“º Entered fullscreen"),n.preventDefault()}t.key==="Escape"&&t.type==="keyDown"&&a.isFullScreen()&&(a.setFullScreen(!1),console.log("ðŸ“º Exited fullscreen"),n.preventDefault())}),D){const n=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173";a.loadURL(n+"/projector")}else a.loadFile(l.join(__dirname,"../dist/index.html"),{hash:"/projector"});return a.on("closed",()=>{a=null}),a}c.handle("get-available-monitors",()=>{const r=C.getAllDisplays();console.log(`IPC: get-available-monitors returning ${r.length} displays`);const n=r.map((t,e)=>{const s=t.id===C.getPrimaryDisplay().id;return`Monitor ${e+1}${s?" (Primary)":""} - ${t.bounds.width}x${t.bounds.height}`});return console.log("Available monitors:",n),n});c.handle("open-projector-window",(r,n)=>{if(a)return a.focus(),{success:!0};try{return L(n),{success:!0}}catch(t){return console.error("Failed to open projector:",t),{success:!1,error:t.message}}});c.handle("close-projector-window",()=>(a&&(a.close(),a=null),{success:!0}));c.handle("update-projector",(r,n)=>(console.log("Main: Received update-projector, data length:",n.length),a&&!a.isDestroyed()?(console.log("Main: Sending to projector window"),a.webContents.send("update-slide",n),{success:!0}):(console.log("Main: Projector window not available"),{success:!1,error:"Projector window not open"})));c.on("video-ended",()=>{console.log("Main: Video ended notification from projector, forwarding to control window"),o&&!o.isDestroyed()&&o.webContents.send("video-ended-notification")});c.on("control-projector-video",(r,n,t)=>{console.log("Main: Video control command from control window:",n,t),a&&!a.isDestroyed()&&a.webContents.send("video-control-command",n,t)});c.on("video-state-update",(r,n)=>{o&&!o.isDestroyed()&&o.webContents.send("video-state-notification",n)});c.handle("window-minimize",()=>{o&&!o.isDestroyed()&&o.minimize()});c.handle("window-maximize",()=>{o&&!o.isDestroyed()&&(o.isMaximized()?o.unmaximize():o.maximize())});c.handle("window-close",()=>{o&&!o.isDestroyed()&&o.close()});c.handle("save-presentation",async(r,n)=>{try{const{filePath:t,canceled:e}=await S.showSaveDialog(o,{title:"Save Presentation",defaultPath:"presentation.json",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}]});return!e&&t?(i.writeFileSync(t,n,"utf-8"),{success:!0,filePath:t}):{success:!1,canceled:!0}}catch(t){return console.error("Save failed:",t),{success:!1,error:t.message}}});c.handle("load-presentation",async()=>{try{const{filePaths:r,canceled:n}=await S.showOpenDialog(o,{title:"Load Presentation",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}],properties:["openFile"]});return!n&&r.length>0?{success:!0,data:i.readFileSync(r[0],"utf-8")}:{success:!1,canceled:!0}}catch(r){return console.error("Load failed:",r),{success:!1,error:r.message}}});c.handle("select-images",async()=>{try{const{filePaths:r,canceled:n}=await S.showOpenDialog(o,{title:"Select Images",filters:[{name:"Images",extensions:["png","jpg","jpeg","gif","webp","svg","bmp"]}],properties:["openFile","multiSelections"]});return!n&&r.length>0?{success:!0,files:r}:{success:!1,canceled:!0}}catch(r){return console.error("Image selection failed:",r),{success:!1,error:r.message}}});c.handle("create-library",async(r,n,t)=>{try{const e=l.join(n,`${t}.dclib`);i.mkdirSync(e,{recursive:!0}),i.mkdirSync(l.join(e,"assets","branding"),{recursive:!0}),i.mkdirSync(l.join(e,"assets","media"),{recursive:!0}),i.mkdirSync(l.join(e,"assets",".trash"),{recursive:!0}),i.mkdirSync(l.join(e,"events"),{recursive:!0});const s={name:t,created:new Date().toISOString(),version:"1.0",lastOpened:new Date().toISOString()};return i.writeFileSync(l.join(e,"library.json"),JSON.stringify(s,null,2),"utf-8"),e}catch(e){return console.error("Create library failed:",e),null}});c.handle("load-library-metadata",async(r,n)=>{try{const t=l.join(n,"library.json");if(i.existsSync(t)){const e=i.readFileSync(t,"utf-8");return JSON.parse(e)}return null}catch(t){return console.error("Load library metadata failed:",t),null}});c.handle("save-library-metadata",async(r,n,t)=>{try{const e=l.join(n,"library.json");return i.writeFileSync(e,JSON.stringify(t,null,2),"utf-8"),!0}catch(e){return console.error("Save library metadata failed:",e),!1}});c.handle("list-library-events",async(r,n)=>{try{const t=l.join(n,"events");return i.existsSync(t)?i.readdirSync(t).filter(s=>s.endsWith(".json")).map(s=>s.replace(".json","")).sort():[]}catch(t){return console.error("List library events failed:",t),[]}});c.handle("create-library-event",async(r,n,t)=>{try{const e=l.join(n,"events",`${t}.json`),s={title:t,stacks:[]};return i.writeFileSync(e,JSON.stringify(s,null,2),"utf-8"),e}catch(e){return console.error("Create library event failed:",e),null}});c.handle("load-library-event",async(r,n,t)=>{try{const e=l.join(n,"events",`${t}.json`);if(!i.existsSync(e))return{success:!1,error:"Event not found"};const s=i.readFileSync(e,"utf-8");return{success:!0,data:JSON.parse(s),path:e}}catch(e){return console.error("Load library event failed:",e),{success:!1,error:e.message}}});c.handle("save-library-event",async(r,n,t)=>{try{return i.writeFileSync(n,JSON.stringify(t,null,2),"utf-8"),!0}catch(e){return console.error("Save library event failed:",e),!1}});c.handle("delete-library-event",async(r,n,t)=>{try{const e=l.join(n,"events",`${t}.json`);return i.existsSync(e)?(i.unlinkSync(e),!0):!1}catch(e){return console.error("Delete library event failed:",e),!1}});c.handle("resolve-asset-path",async(r,n,t)=>{try{if(t.startsWith("local-image://"))return t;if(t.startsWith("file://")){let d=t.replace("file://","");return process.platform==="win32"&&d.startsWith("/")&&(d=d.substring(1)),`local-image://${d}`}if(!t.startsWith("assets://"))return t;const e=t.replace("assets://","assets/"),s=l.join(n,e);if(i.existsSync(s))return`local-image://${process.platform==="win32"?s.replace(/\\/g,"/"):s}`;const f=s.replace("/assets/","/assets/.trash/");return i.existsSync(f)?f:null}catch(e){return console.error("Resolve asset path failed:",e),null}});c.handle("select-library-folder",async()=>{try{const{filePaths:r,canceled:n}=await S.showOpenDialog(o,{title:"Select Library Folder",properties:["openDirectory"]});return!n&&r.length>0?{success:!0,path:r[0]}:{success:!1,canceled:!0}}catch(r){return console.error("Select library folder failed:",r),{success:!1,error:r.message}}});c.handle("list-library-assets",async(r,n)=>{try{let e=function(m,j){if(!i.existsSync(m))return;const F=i.readdirSync(m,{withFileTypes:!0});for(const u of F)if(u.isDirectory()){if(u.name===".trash")continue;const y=l.join(m,u.name),b=`${j}${u.name}/`;e(y,b)}else if(u.isFile()){const y=u.name.split(".").pop().toLowerCase(),b=l.join(m,u.name),x=`${j}${u.name}`;let h=null;f.includes(y)?h="image":d.includes(y)&&(h="video"),h&&s.push({filename:u.name,path:b,url:x,type:h})}};var t=e;if(!n)return{success:!1,assets:[]};const s=[],f=["png","jpg","jpeg","gif","webp","svg","bmp"],d=["mp4","webm","ogg","mov","avi","mkv"],p=l.join(n,"assets","branding");e(p,"assets://branding/");const w=l.join(n,"assets","media");return e(w,"assets://media/"),{success:!0,assets:s}}catch(e){return console.error("List library assets failed:",e),{success:!1,assets:[],error:e.message}}});c.handle("import-assets-to-library",async(r,n,t)=>{try{if(!n)return{success:!1,error:"No library open"};let e=[];t==="image"?e=[{name:"Images",extensions:["png","jpg","jpeg","gif","webp","svg","bmp"]}]:t==="video"?e=[{name:"Videos",extensions:["mp4","webm","ogg","mov","avi","mkv"]}]:e=[{name:"Media Files",extensions:["png","jpg","jpeg","gif","webp","svg","bmp","mp4","webm","ogg","mov","avi","mkv"]}];const{filePaths:s,canceled:f}=await S.showOpenDialog(o,{title:"Import Assets",filters:e,properties:["openFile","multiSelections"]});if(f||s.length===0)return{success:!1,canceled:!0};const d=new Date,p=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`,w=l.join(n,"assets","media",p);i.mkdirSync(w,{recursive:!0});const m=[],j=["png","jpg","jpeg","gif","webp","svg","bmp"],F=["mp4","webm","ogg","mov","avi","mkv"];for(const u of s){const y=l.basename(u),b=l.join(w,y);i.copyFileSync(u,b);const x=y.split(".").pop().toLowerCase();let h="unknown";j.includes(x)?h="image":F.includes(x)&&(h="video");const I=`assets://media/${p}/${y}`;m.push({filename:y,path:b,url:I,type:h})}return{success:!0,assets:m}}catch(e){return console.error("Import assets failed:",e),{success:!1,error:e.message}}});c.handle("check-asset-usage",async(r,n,t)=>{try{if(!n||!t)return[];const e=l.join(n,"events");if(!i.existsSync(e))return[];const s=i.readdirSync(e).filter(d=>d.endsWith(".json")),f=[];for(const d of s){const p=l.join(e,d);try{if(i.readFileSync(p,"utf-8").includes(t)){const m=d.replace(".json","");f.push(m)}}catch(w){console.error(`Error reading event file ${d}:`,w)}}return f}catch(e){return console.error("Check asset usage failed:",e),[]}});c.handle("delete-library-asset",async(r,n,t)=>{try{return!n||!t?{success:!1,error:"Invalid parameters"}:t.startsWith(n)?i.existsSync(t)?(i.unlinkSync(t),console.log("Asset deleted:",t),{success:!0}):{success:!1,error:"Asset file not found"}:{success:!1,error:"Asset path is not within library"}}catch(e){return console.error("Delete asset failed:",e),{success:!1,error:e.message}}});function v(r){o&&o.webContents&&o.webContents.send("main-process-log",r)}g.whenReady().then(()=>{E.registerFileProtocol("local-image",(r,n)=>{const t=`local-image protocol request: ${r.url}`;console.log(t),v(t);let e=decodeURIComponent(r.url.replace("local-image://",""));v(`After removing protocol: ${e}`),process.platform==="win32"&&e.match(/^\/[A-Za-z]:/)&&(e=e.substring(1),v(`After removing leading slash: ${e}`)),process.platform==="win32"&&(e=e.replace(/\//g,"\\"),v(`After converting slashes: ${e}`),e.match(/^[A-Za-z]:\\/)||(v(`WARNING: Path missing colon after drive letter: ${e}`),e=e.replace(/^([A-Za-z])\\/,"$1:\\"),v(`Fixed path: ${e}`)));try{if(v(`Checking if file exists: ${e}`),i.existsSync(e)){v(`File exists! Returning path: ${e}`);const s=i.statSync(e),f=l.extname(e).toLowerCase(),p={".mp4":"video/mp4",".webm":"video/webm",".ogg":"video/ogg",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".webp":"image/webp"}[f];p?n({path:e,headers:{"Content-Type":p,"Accept-Ranges":"bytes","Cache-Control":"public, max-age=31536000, immutable",ETag:`"${s.mtime.getTime()}-${s.size}"`,"Last-Modified":s.mtime.toUTCString()}}):(console.log("Returning path to callback:",e),n({path:e}))}else{console.error("Asset file not found:",e);const s=decodeURIComponent(r.url.replace("local-image://",""));console.log("Trying original path:",s),i.existsSync(s)?(console.log("Original path exists!"),n({path:s})):n({error:-6})}}catch(s){console.error("Error loading asset:",e,s),n({error:-2})}}),k(),g.on("activate",()=>{P.getAllWindows().length===0&&k()})});g.on("window-all-closed",()=>{process.platform!=="darwin"&&g.quit()});
